<!-- post_detail.html -->
<!-- {% extends 'base.html' %}

{% block content %}
  <div class="container">
    <div class="row">
      <div class="col-md-8 offset-md-2">
        <article class="card my-4">
          {% if post.thumbnail %}
            <img src="{{ post.thumbnail.url }}" class="card-img-top" alt="{{ post.title }}">
          {% endif %}
          <div class="card-body">
            {% if post.content_type == 'article' %}
            <div class="d-flex justify-content-between align-items-center">
              <h1 class="card-title">{{ post.title }}</h1>
              <h5>
                <a href="{% url 'accounts:profile' post.author.username %}" class="username-link">{{ post.author.username }}</a>
                <div class="hover-card">
                  {% include 'accounts/hover_card.html' with user=post.author %}
                </div>
              </h5>
            </div>
          {% elif post.content_type == 'tweet' %}
            <h1 class="card-title">
              <a href="{% url 'accounts:profile' post.author.username %}" class="username-link">{{ post.author.username }}</a>
              <div class="hover-card">
                {% include 'accounts/hover_card.html' with user=post.author %}
              </div>
            </h1>
          {% endif %}
            <p class="card-text">{{ post.content|linebreaks }}</p>
            <div class="media-preview">
              {% for media in post.media_post.all %}
              {% if media.media_type == 'image' %}
                  <img src="{{ media.file.url }}" alt="Media">
              {% elif media.media_type == 'video' %}
                  <video controls>
                      <source src="{{ media.file.url }}" type="video/mp4">
                      Your browser does not support the video tag.
                  </video>
              {% elif media.media_type == 'audio' %}
                  <audio controls>
                      <source src="{{ media.file.url }}" type="audio/mpeg">
                      Your browser does not support the audio tag.
                  </audio>
              {% endif %}
              {% endfor %}
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                {% if request.user.is_authenticated and request.user != post.author %}
                  {% if request.user in post.likes.all %}
                    <a href="{% url 'memorymap:like_post' post.uuid %}" class="btn btn-sm btn-danger">いいね解除</a>
                  {% else %}
                    <a href="{% url 'memorymap:like_post' post.uuid %}" class="btn btn-sm btn-primary">いいね</a>
                  {% endif %}
                {% endif %}
                <span class="ml-2">{{ like_count  }}人がいいねしました</span>
              </div>
              <small class="text-muted">{{ post.created_at|date:"Y/m/d H:i" }}</small>
              <div class="mt-2">
                {% if is_new_visitor %}
                  <p class="text-success">ようこそ！この投稿を初めて閲覧しています。</p>
                {% else %}
                  <p class="text-muted">前回の閲覧から{{ last_access_time|timesince }}が経過しました。</p>
                {% endif %}
              {% if request.user == post.author %}
                <div>
                  <a href="{% url 'memorymap:post_update' post.author.username post.uuid %}" class="btn btn-sm btn-outline-secondary">編集</a>
                  <a href="{% url 'memorymap:post_delete' post.author.username post.uuid %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('本当に削除しますか？')">削除</a>
                </div>
              {% endif %}
            </div>
          </div>
        </article>
        <h2 class="my-4">コメント</h2>
        {% for comment in post.comments.all %}
          <div class="media mb-4">
            <img src="{{ comment.user.profile_picture.url }}" class="mr-3 rounded-circle" alt="{{ comment.user.username }}" width="50" height="50">
            <div class="media-body">
              <h5 class="mt-0">{{ comment.user.username }} <small class="text-muted">{{ comment.created_at|date:"Y/m/d H:i" }}</small></h5>
              {{ comment.content|linebreaks }}
            </div>
            <div class="comment">
              {% if request.user == comment.user %}
                <a href="{% url 'memorymap:comment_edit' comment.id %}">編集</a>
                <a href="{% url 'memorymap:comment_delete' comment.id %}" onclick="return confirm('本当に削除しますか？')">削除</a>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p>まだコメントはありません。</p>
        {% endfor %}

        {% if request.user.is_authenticated %}
          <h3 class="my-4">コメントを書く</h3>
          <form method="post" action="{% url 'memorymap:post_detail' post.author.username post.uuid %}">
            {% csrf_token %}
            {{ comment_form.as_p }}
            <button type="submit" class="btn btn-primary">コメントを投稿</button>
          </form>
        {% else %}
          <p>コメントを書くには<a href="{% url 'accounts:login' %}">ログイン</a>してください。</p>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function () {
      $('.media-preview .thumb i').on('click', function () {
          var thumb = $(this).parent('.thumb');
          var mediaId = thumb.attr('data-id');
          $.get('{% url "memorymap:delete_media" %}?media_id=' + mediaId, function (data) {
              if (data.status === 'success') {
                  thumb.remove();
              }
          });
      });
  });
</script>
{% endblock %} -->

<!-- post_detail.html -->
{% extends 'base.html' %}

{% block extra_css %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css">
  <style>
    .comment-level-1 { margin-left: 20px; }
    .comment-level-2 { margin-left: 40px; }
    .comment-level-3 { margin-left: 60px; }
    .reply-form { margin-top: 10px; }
    .reply-form:not(#comment-form-main) { display: none; }
    .children {
      margin-left: 20px;
      border-left: 1px solid #ccc;
      padding-left: 10px;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container">
    <div class="row">
      <div class="col-md-8 offset-md-2">
        <article class="card my-4">
          {% if post.thumbnail %}
            <img src="{{ post.thumbnail.url }}" class="card-img-top" alt="{{ post.title }}">
          {% endif %}
          <div class="card-body">
            {% if post.content_type == 'article' %}
              <h1 class="card-title">{{ post.title }}</h1>
            {% endif %}
            <h5 class="card-subtitle mb-2 text-muted">
              <a href="{% url 'accounts:profile' post.author.username %}">{{ post.author.username }}</a>
            </h5>
            <p class="card-text">{{ post.content|linebreaks }}</p>
            <div class="media-preview">
              {% for media in media %}
                {% include 'memorymap/media_item.html' with media=media %}
              {% endfor %}
            </div>
            <p class="card-text"><small class="text-muted">{{ post.created_at|date:"Y/m/d H:i" }}</small></p>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                {% if user.is_authenticated and user != post.author %}
                  <a href="{% url 'memorymap:like_post' post.uuid %}" class="btn btn-sm {% if user in post.likes.all %}btn-danger{% else %}btn-primary{% endif %}">
                    {% if user in post.likes.all %}いいね解除{% else %}いいね{% endif %}
                  </a>
                {% endif %}
                <span class="ml-2">{{ like_count }}人がいいねしました</span>
              </div>
              {% if user == post.author %}
                <div>
                  <a href="{% url 'memorymap:post_update' post.author.username post.uuid %}" class="btn btn-sm btn-outline-secondary">編集</a>
                  <a href="{% url 'memorymap:post_delete' post.author.username post.uuid %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('本当に削除しますか？')">削除</a>
                </div>
              {% endif %}
            </div>
          </div>
        </article>

        <h2 class="my-4">コメント</h2>
        <div id="comments-container">
          {% include 'memorymap/comment_thread.html' with comments=comments %}
        </div>

        {% if user.is_authenticated %}
          <h3 class="my-4">コメントを書く</h3>
          <div id="main-comment-form" style="display: block;">
            {% include 'memorymap/comment_form.html' with form=comment_form parent_id=post.id %}
          </div>
        {% else %}
          <p>コメントを書くには<a href="{% url 'accounts:login' %}">ログイン</a>してください。</p>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
  <script>
    Dropzone.autoDiscover = false;

    function initializeDropzone(formId) {
      console.log('Initializing Dropzone for', formId);
      var dropzoneElement = document.getElementById('comment-dropzone-' + formId);
      if (dropzoneElement && !dropzoneElement.dropzone) {
        console.log('Dropzone element found, creating instance');
        new Dropzone("#comment-dropzone-" + formId, {
          url: "{% url 'memorymap:file_upload' %}",
          maxFilesize: "{{ dropzone_config.maxFilesize }}",
          acceptedFiles: "{{ dropzone_config.acceptedFiles }}",
          addRemoveLinks: true,
          autoProcessQueue: false,
          uploadMultiple: false,
          parallelUploads: 5,
          maxFiles: 5,
          paramName: "file",
          headers: {
            'X-CSRFToken': getCookie("csrftoken")
          },
          init: function() {
            var dz = this;
            document.getElementById("comment-form-" + formId).addEventListener("submit", function(e) {
              e.preventDefault();
              if (dz.getQueuedFiles().length > 0) {
                dz.processQueue();
              } else {
                submitForm(formId);
              }
            });

            dz.on("sending", function(file, xhr, formData) {
              var form = document.getElementById("comment-form-" + formId);
              var formDataEntries = new FormData(form);
              for (var pair of formDataEntries.entries()) {
                if (pair[0] !== 'file') {
                  formData.append(pair[0], pair[1]);
                }
              }
            });

            dz.on("success", function(file, response) {
              var fileIds = document.getElementById("file_ids-" + formId);
              if (fileIds.value) {
                fileIds.value += ',' + response.file_id;
              } else {
                fileIds.value = response.file_id;
              }
            });

            dz.on("queuecomplete", function() {
              submitForm(formId);
            });

            dz.on("error", function(file, errorMessage) {
              console.error("Upload error:", errorMessage);
              alert("ファイルのアップロードに失敗しました: " + JSON.stringify(errorMessage));
            });
          }
        });
      } else {
        console.log('Dropzone element not found or already initialized');
      }
    }

    function submitForm(formId) {
      var form = document.getElementById("comment-form-" + formId);
      var formData = new FormData(form);
      fetch("{% url 'memorymap:add_comment' post.uuid %}", {
        method: "POST",
        body: formData,
        headers: {
          'X-CSRFToken': getCookie("csrftoken")
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          var newCommentHtml = data.html;
          if (formId === 'main') {
            document.getElementById("comments-container").insertAdjacentHTML('beforeend', newCommentHtml);
          } else {
            var parentComment = document.getElementById("comment-" + formId);
            var childCommentsContainer = parentComment.querySelector('.children');
            if (!childCommentsContainer) {
              childCommentsContainer = document.createElement('div');
              childCommentsContainer.className = 'children ml-4';
              parentComment.appendChild(childCommentsContainer);
            }
            childCommentsContainer.insertAdjacentHTML('beforeend', newCommentHtml);
          }
          var newComment = document.getElementById("comment-" + data.comment_id);
          if (newComment) {
            setupCommentEventListeners(newComment);
          }
          form.reset();
          Dropzone.forElement("#comment-dropzone-" + formId).removeAllFiles();
          if (formId !== 'main') {
            form.style.display = 'none';
          }
        } else {
          alert('エラーが発生しました。もう一度お試しください。');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。もう一度お試しください。');
      });
    }

    function toggleReplyForm(commentId) {
      var form = document.getElementById("comment-form-" + commentId);
      if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
        initializeDropzone(commentId);
      } else {
        form.style.display = 'none';
      }
    }

    function editComment(commentId) {
        var commentElement = document.getElementById("comment-" + commentId);
        var contentElement = commentElement.querySelector(".comment-content");
        var currentContent = contentElement.getAttribute("data-original-content");
        
        // 既存の編集フォームがあれば削除
        var existingForm = commentElement.querySelector('.edit-comment-form');
        if (existingForm) {
            existingForm.remove();
        }

        var formHtml = `
            <form id="edit-form-${commentId}" class="edit-comment-form">
                <textarea name="content" class="form-control">${currentContent}</textarea>
                <button type="submit" class="btn btn-primary mt-2">更新</button>
                <button type="button" class="btn btn-secondary mt-2" onclick="cancelEdit(${commentId})">キャンセル</button>
            </form>
        `;
        
        // 元のコンテンツを非表示にし、フォームを挿入
        contentElement.style.display = 'none';
        contentElement.insertAdjacentHTML('afterend', formHtml);
        
        document.getElementById(`edit-form-${commentId}`).addEventListener('submit', function(e) {
            e.preventDefault();
            submitEditForm(commentId);
        });
    }

    

    function submitEditForm(commentId) {
        var form = document.getElementById(`edit-form-${commentId}`);
        var formData = new FormData(form);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        formData.append('content_type', 'tweet');
        formData.append('visibility', 'public');

        console.log('Submitting edit form data:', Object.fromEntries(formData));

        fetch("{% url 'memorymap:edit_comment' 0 %}".replace('0', commentId), {
            method: "POST",
            body: formData,
            headers: {
                'X-CSRFToken': getCookie("csrftoken")
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                var commentElement = document.getElementById("comment-" + commentId);
                // コメント要素全体を更新された HTML で置き換え
                commentElement.outerHTML = data.html;
                
                // 新しく追加された要素にイベントリスナーを再設定
                var newCommentElement = document.getElementById("comment-" + commentId);
                setupCommentEventListeners(newCommentElement);
            } else {
                console.error('Edit error:', data.errors);
                alert('コメントの更新に失敗しました。');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('エラーが発生しました。もう一度お試しください。');
        });
    }

    function setupCommentEventListeners(commentElement) {
      var replyButton = commentElement.querySelector('.btn-outline-primary');
      var editButton = commentElement.querySelector('.btn-outline-secondary');
      var deleteButton = commentElement.querySelector('.btn-outline-danger');

      if (replyButton) {
        replyButton.addEventListener('click', function() {
          var commentId = this.closest('.comment').id.split('-')[1];
          toggleReplyForm(commentId);
        });
      }

      if (editButton) {
        editButton.addEventListener('click', function() {
          var commentId = this.closest('.comment').id.split('-')[1];
          editComment(commentId);
        });
      }

      if (deleteButton) {
        deleteButton.addEventListener('click', function() {
          var commentId = this.closest('.comment').id.split('-')[1];
          deleteComment(commentId);
        });
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
        var comments = document.querySelectorAll('.comment');
        comments.forEach(setupCommentEventListeners);
    });

    function cancelEdit(commentId) {
        var commentElement = document.getElementById("comment-" + commentId);
        var contentElement = commentElement.querySelector(".comment-content");
        var editForm = commentElement.querySelector('.edit-comment-form');

        if (editForm) {
            editForm.remove();
        }
        contentElement.style.display = ''; // 元のコンテンツを再表示
    }
    function deleteComment(commentId) {
      if (confirm('本当にこのコメントを削除しますか？')) {
        fetch("{% url 'memorymap:delete_comment' 0 %}".replace('0', commentId), {
          method: "POST",
          headers: {
            'X-CSRFToken': getCookie("csrftoken")
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            var commentElement = document.getElementById("comment-" + commentId);
            commentElement.remove();
          } else {
            alert('コメントの削除に失敗しました。');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('エラーが発生しました。もう一度お試しください。');
        });
      }
    }

    function restructureComments() {
      var comments = document.querySelectorAll('.comment');
      comments.forEach(function(comment) {
        var parentId = comment.dataset.parentId;
        if (parentId && parentId !== 'main') {
          var parentComment = document.getElementById('comment-' + parentId);
          if (parentComment) {
            var childrenContainer = parentComment.querySelector('.children');
            if (!childrenContainer) {
              childrenContainer = document.createElement('div');
              childrenContainer.className = 'children ml-4';
              parentComment.appendChild(childrenContainer);
            }
            childrenContainer.appendChild(comment);
          }
        }
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      //debug
      console.log('CSRF token:', cookieValue);
      return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    initializeDropzone('main');
    restructureComments();
    var comments = document.querySelectorAll('.comment');
    comments.forEach(setupCommentEventListeners);
  });
  </script>
{% endblock %}