{% extends './base.html' %}
{% block content %}

<h1>{{ article.title }}</h1>
<div>
    <p>{{ article.category.name }}</p>
    <p>{{ article.content }}</p>
    {% if article.image.url is not NULL %}
    <img src="{{article.image.url}}" alt="{{ article.title }}">
    {% endif %}
</div>

<!-- <link rel="stylesheet" href="../../static/App_Folder_css/article_detail.css"> -->



<style>
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    #street-view {
        height: 1000px;
        width: 1000px;
    }
</style>
<body>

    <div id="street-view"></div>
    
    <script>
        const LIMIT = 30; // 移動回数の上限値
        const WAIT_SECOND = 2; // 次に移動するまでの秒数
        const START_LAT_LNG = {lat:42.345573, lng: -71.098326}; // 開始地点の緯度、経度
        const START_HEADING = 180; // 開始時の方角
        let panorama;
    
        // GoogleMapApi 読み込み時にcallbackで呼び出される
        function initMap() {
            let Links, count = 0, timer_id;
    
            // ストリートビューの表示
            panorama = new google.maps.StreetViewPanorama(
                document.getElementById('street-view'), {
                    position: START_LAT_LNG,
                    pov: {
                        heading: START_HEADING,
                        pitch: 0
                    },
                    zoom: 1
                }); // 
    
            // 画面内のリンクを取得
            Links = panorama.getLinks();
    
            // ストリートビューの状態が変更されるたびに実行される
            google.maps.event.addListener(panorama, 'status_changed', function () { // 
                if (panorama.getStatus() == "OK") {
                    Links = panorama.getLinks();
    
                    if (count > LIMIT) {
                        alert('stop');
                        return false;
                    }
    
                    setTimeout(
                        function () {
                            let target = 0;
                            if (Links.length >= 4) {
                                target = Math.floor(Math.random() * Links.length); // ランダムで選択
                            } else {
                                //現在向ている方向に近いlinkを選択
                                let val = 360;
                                let currentPov = panorama.getPov();
                                Links.forEach(function (element, index) {
                                    let ans = Math.abs(currentPov.heading - element.heading);
                                    if (val > ans) {
                                        val = ans;
                                        target = index;
                                    }
                                });
                            }
                            // 次に移動するLink先に向きを変える
                            panorama.setPov({
                                heading: Links[target].heading,
                                pitch: 0
                            });
                            // 次のストリートビューに移動する
                            panorama.setPano(Links[target]['pano']);
                            count++;
                        },
                        WAIT_SECOND * 1000
                    );
                }
            });
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.52&key=AIzaSyC1JzoyI8N7Ju0cccYnOVvAftcdy-c5JAg&callback=initMap"
            defer></script>
    </body>

<div>| 
    <a href='{% url "memorymap:index" %}'>一覧</a> |
    <a href='{% url "memorymap:update" article.pk %}'>編集</a> |
    <a href='{% url "memorymap:delete" article.pk %}'>削除</a> |
</div>

{% endblock %}